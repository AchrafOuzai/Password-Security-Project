#!/usr/bin/env python3
"""
Script to extract bcrypt hashes from the secure database
Usage: python extract_hashes_secure.py
"""

import sqlite3
import os

def extract_bcrypt_hashes():
    """Extract all bcrypt hashes from the secure database"""
    
    # Path to the secure database
    db_path = '../secure_app/database.db'
    
    if not os.path.exists(db_path):
        print(f"‚ùå Error: Database not found at {db_path}")
        print("Make sure the secure application has been run at least once.")
        print("\nTo launch the secure application:")
        print("  cd ../secure_app")
        print("  python app.py")
        return
    
    try:
        # Connect to the database
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        
        # Extract users and their hashes
        cursor.execute("SELECT username, password FROM users")
        users = cursor.fetchall()
        
        if not users:
            print("‚ö†Ô∏è No users found in the database.")
            print("Create accounts first via the secure application.")
            return
        
        # Create the bcrypt hash file
        output_file = 'hashes_bcrypt.txt'
        with open(output_file, 'w') as f:
            for username, hash_value in users:
                f.write(f"{hash_value}\n")
        
        # Create a detailed file with usernames for reference
        output_file_detailed = 'hashes_bcrypt_detailed.txt'
        with open(output_file_detailed, 'w') as f:
            f.write("Username:Bcrypt hash\n")
            f.write("-" * 80 + "\n")
            for username, hash_value in users:
                f.write(f"{username}:{hash_value}\n")
        
        print("‚úÖ Extraction successful!")
        print(f"\nüìä Statistics:")
        print(f"   - Number of users: {len(users)}")
        print(f"   - Hash file created: {output_file}")
        print(f"   - Detailed file created: {output_file_detailed}")
        
        print(f"\nüìã Extracted bcrypt hashes:")
        print("-" * 80)
        for username, hash_value in users:
            # Show truncated hash for readability
            hash_display = hash_value[:60] + "..." if len(hash_value) > 60 else hash_value
            print(f"   {username:15s} : {hash_display}")
        print("-" * 80)
        
        # Analyze the structure of a bcrypt hash
        if users:
            sample_hash = users[0][1]
            print(f"\nüîç Analyzing a bcrypt hash:")
            print(f"   Full hash: {sample_hash}")
            
            if sample_hash.startswith('$2b$'):
                parts = sample_hash.split('$')
                print(f"\n   Structure:")
                print(f"   - Version: {parts[1]} (bcrypt)")
                print(f"   - Rounds: {parts[2]} (2^{parts[2]} = {2**int(parts[2])} iterations)")
                print(f"   - Salt: {parts[3][:22]} (22 characters)")
                print(f"   - Hash: {parts[3][22:]} (31 characters)")
        
        print(f"\n‚ö†Ô∏è  DIFFERENCE WITH MD5:")
        print(f"   MD5:    32 hexadecimal characters")
        print(f"   bcrypt: 60 characters with complex structure")
        print(f"   bcrypt: Unique salt embedded in each hash")
        print(f"   bcrypt: Intentionally SLOW (~300ms per hash)")
        
        print(f"\nüî® Cracking attempt:")
        print(f"   To attempt cracking these bcrypt hashes:")
        print(f"   python brute_force_bcrypt.py")
        print(f"\n   ‚ö†Ô∏è  WARNING: This will take a VERY long time!")
        print(f"   Estimated: Several days to many years")
        
        conn.close()
        
    except sqlite3.Error as e:
        print(f"‚ùå SQLite Error: {e}")
    except Exception as e:
        print(f"‚ùå Error: {e}")

def compare_hash_types():
    """Compare both hash types"""
    print("\n" + "="*80)
    print("üìä COMPARISON: MD5 vs bcrypt")
    print("="*80)
    
    # Check if MD5 hashes exist
    md5_exists = os.path.exists('hashes.txt')
    bcrypt_exists = os.path.exists('hashes_bcrypt.txt')
    
    if md5_exists and bcrypt_exists:
        # Read MD5 hashes
        with open('hashes.txt', 'r') as f:
            md5_hashes = [line.strip() for line in f if line.strip()]
        
        # Read bcrypt hashes
        with open('hashes_bcrypt.txt', 'r') as f:
            bcrypt_hashes = [line.strip() for line in f if line.strip()]
        
        print(f"\nüìã Summary:")
        print(f"   MD5 hashes found: {len(md5_hashes)}")
        print(f"   bcrypt hashes found: {len(bcrypt_hashes)}")
        
        if md5_hashes and bcrypt_hashes:
            print(f"\nüîç Example of each type:")
            print(f"\n   MD5 (vulnerable app):")
            print(f"   {md5_hashes[0]}")
            print(f"   Length: {len(md5_hashes[0])} characters")
            print(f"   Format: Simple hexadecimal")
            print(f"   Salt: ‚ùå None")
            
            print(f"\n   bcrypt (secure app):")
            print(f"   {bcrypt_hashes[0]}")
            print(f"   Length: {len(bcrypt_hashes[0])} characters")
            print(f"   Format: $2b$rounds$salt$hash")
            print(f"   Salt: ‚úÖ Unique and embedded")
            
            print(f"\nüí° Observation:")
            print(f"   Even if two users have the SAME password,")
            print(f"   their bcrypt hashes will be DIFFERENT due to the unique salt!")
    
    elif md5_exists:
        print(f"\n‚ö†Ô∏è  MD5 hashes found but no bcrypt hashes")
        print(f"   Run the secure application and create accounts")
    
    elif bcrypt_exists:
        print(f"\n‚úÖ bcrypt hashes found")
        print(f"   To compare, also run the vulnerable application")
    
    else:
        print(f"\n‚ö†Ô∏è  No hashes found")
        print(f"   Run both applications and create accounts")

if __name__ == "__main__":
    print("="*80)
    print("üîí BCRYPT HASH EXTRACTOR - SECURE APPLICATION")
    print("="*80)
    print("\nThis script extracts bcrypt hashes from the secure database")
    print("to demonstrate RESISTANCE to cracking.\n")
    
    extract_bcrypt_hashes()
    compare_hash_types()


