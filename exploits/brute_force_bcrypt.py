#!/usr/bin/env python3
"""
Brute force script to attempt cracking bcrypt hashes
Usage: python brute_force_bcrypt.py

WARNING: This script is VERY SLOW by design (that‚Äôs the purpose of bcrypt!)
"""

import bcrypt
import time
from datetime import datetime, timedelta

def load_hashes(filename='hashes_bcrypt.txt'):
    """Load bcrypt hashes from a file"""
    try:
        with open(filename, 'r') as f:
            hashes = [line.strip() for line in f if line.strip()]
        return hashes
    except FileNotFoundError:
        print(f"‚ùå File {filename} not found!")
        print("Run extract_hashes_secure.py first")
        return []

def load_wordlist(filename='rockyou.txt', max_lines=1000):
    """Load a wordlist (limited for demo)"""
    try:
        with open(filename, 'r', encoding='latin-1', errors='ignore') as f:
            words = [line.strip() for line in f if line.strip()][:max_lines]
        return words
    except FileNotFoundError:
        print(f"‚ùå Wordlist {filename} not found!")
        print("Using a small test list instead...")
        # Basic test list
        return ['password', '123456', 'password123', 'admin', 'letmein', 
                'qwerty', 'welcome', '12345678', 'abc123', 'password1']

def crack_bcrypt_hash(target_hash, wordlist, max_attempts=100):
    """Attempt to crack a bcrypt hash"""
    for i, word in enumerate(wordlist[:max_attempts]):
        try:
            # Check if password matches
            if bcrypt.checkpw(word.encode('utf-8'), target_hash.encode('utf-8')):
                return word
        except Exception:
            # Ignore format errors
            pass
        
        # Show progress every 10 attempts
        if (i + 1) % 10 == 0:
            print(f"   ... {i + 1} attempts done", end='\r')
    
    return None

def estimate_cracking_time(hash_count, wordlist_size, time_per_hash):
    """Estimate total cracking time"""
    total_checks = hash_count * wordlist_size
    total_seconds = total_checks * time_per_hash
    
    return {
        'seconds': total_seconds,
        'minutes': total_seconds / 60,
        'hours': total_seconds / 3600,
        'days': total_seconds / 86400,
        'years': total_seconds / 31536000
    }

def brute_force_bcrypt_attack():
    """Perform a brute force attack on bcrypt"""
    
    print("="*80)
    print("üî® BRUTE FORCE ATTACK - bcrypt")
    print("="*80)
    print("\n‚ö†Ô∏è  WARNING: bcrypt is INTENTIONALLY SLOW!")
    print("This demonstration will show bcrypt‚Äôs RESISTANCE.\n")
    
    # Load hashes
    print("üì• Loading bcrypt hashes...")
    hashes = load_hashes()
    if not hashes:
        return
    
    print(f"   ‚úÖ {len(hashes)} hashes loaded")
    
    # Load wordlist (limited for demo)
    print("\nüì• Loading wordlist...")
    print("   ‚ÑπÔ∏è  For this demo, limited to 100 passwords")
    print("   (The full rockyou.txt contains 14+ million words)")
    wordlist = load_wordlist(max_lines=100)
    
    print(f"   ‚úÖ {len(wordlist)} passwords loaded")
    
    # Measure bcrypt speed
    print("\n‚è±Ô∏è  Testing bcrypt speed...")
    test_start = time.time()
    test_hash = hashes[0]
    for i in range(5):
        try:
            bcrypt.checkpw(b'test', test_hash.encode('utf-8'))
        except:
            pass
    test_time = (time.time() - test_start) / 5
    
    print(f"   Average verification time: {test_time*1000:.2f}ms")
    print(f"   Speed: ~{1/test_time:.2f} hash/second")
    
    # Estimate cracking time
    print("\nüìä CRACKING TIME ESTIMATES:")
    print("-"*80)
    
    estimates = estimate_cracking_time(len(hashes), len(wordlist), test_time)
    
    print(f"\nFor {len(hashes)} hash(es) with {len(wordlist)} passwords:")
    print(f"   - Seconds: {estimates['seconds']:,.0f}")
    print(f"   - Minutes: {estimates['minutes']:,.1f}")
    print(f"   - Hours:   {estimates['hours']:,.1f}")
    
    if estimates['days'] < 1:
        print(f"   - Total time: ~{estimates['hours']:.1f} hours")
    elif estimates['days'] < 365:
        print(f"   - Total time: ~{estimates['days']:.1f} days")
    else:
        print(f"   - Total time: ~{estimates['years']:.1f} years")
    
    # Estimate with full wordlist
    print(f"\nWith full rockyou.txt wordlist (14,344,391 words):")
    full_estimates = estimate_cracking_time(len(hashes), 14344391, test_time)
    
    if full_estimates['days'] < 365:
        print(f"   - Estimated time: ~{full_estimates['days']:.0f} days")
    else:
        print(f"   - Estimated time: ~{full_estimates['years']:.1f} years")
    
    print("\n" + "="*80)
    
    # Ask for confirmation
    print("\n‚ö†Ô∏è  Do you really want to start the attack?")
    print(f"   It will take ~{estimates['hours']:.1f} hours for {len(wordlist)} words.")
    print("\n   Options:")
    print("   1) Continue with ALL words (very long)")
    print("   2) Quick test (10 words only)")
    print("   3) Cancel")
    
    choice = input("\nYour choice (1/2/3): ").strip()
    
    if choice == '3':
        print("\n‚ùå Attack canceled.")
        return
    elif choice == '2':
        wordlist = wordlist[:10]
        print(f"\n‚úÖ Test mode: Only {len(wordlist)} passwords")
    else:
        print(f"\n‚úÖ Full mode: {len(wordlist)} passwords")
    
    # Start attack
    print("\nüöÄ Starting attack...")
    print("-"*80)
    
    start_time = time.time()
    results = []
    
    for i, target_hash in enumerate(hashes, 1):
        print(f"\n[{i}/{len(hashes)}] Hash: {target_hash[:50]}...")
        
        hash_start = time.time()
        password = crack_bcrypt_hash(target_hash, wordlist, max_attempts=len(wordlist))
        hash_time = time.time() - hash_start
        
        if password:
            print(f"   ‚úÖ FOUND! Password: '{password}' (in {hash_time:.2f}s)")
            results.append({
                'hash': target_hash,
                'password': password,
                'time': hash_time,
                'cracked': True
            })
        else:
            print(f"   ‚ùå Failed after {len(wordlist)} attempts (in {hash_time:.2f}s)")
            results.append({
                'hash': target_hash,
                'password': None,
                'time': hash_time,
                'cracked': False
            })
    
    total_time = time.time() - start_time
    
    # Display results
    print("\n" + "="*80)
    print("üìä BCRYPT ATTACK RESULTS")
    print("="*80)
    
    cracked = sum(1 for r in results if r['cracked'])
    success_rate = (cracked / len(results)) * 100 if results else 0
    
    print(f"\n‚úÖ Hashes cracked: {cracked}/{len(results)} ({success_rate:.1f}%)")
    print(f"‚è±Ô∏è  Total time: {total_time:.2f} seconds ({total_time/60:.2f} minutes)")
    print(f"‚ö° Average speed: {len(wordlist)*len(results)/total_time:.2f} checks/s")
    
    print("\nüìã Details:")
    print("-"*80)
    print(f"{'Hash (truncated)':<52} {'Result':<20} {'Time'}")
    print("-"*80)
    
    for result in results:
        hash_display = result['hash'][:50] + "..."
        password = result['password'] if result['cracked'] else 'NOT FOUND'
        print(f"{hash_display:<52} {password:<20} {result['time']:.2f}s")
    
    # Save results
    if cracked > 0:
        output_file = 'cracked_passwords_bcrypt.txt'
        with open(output_file, 'w') as f:
            f.write(f"bcrypt attack results - {datetime.now()}\n")
            f.write("="*80 + "\n\n")
            f.write(f"Hash:Password\n")
            f.write("-"*80 + "\n")
            for result in results:
                if result['cracked']:
                    f.write(f"{result['hash']}:{result['password']}\n")
        
        print(f"\nüíæ Results saved in: {output_file}")
    
    # Compare with MD5
    print("\n" + "="*80)
    print("üìä COMPARISON: bcrypt vs MD5")
    print("="*80)
    
    print("\nbcrypt (this attack):")
    print(f"   - Speed: ~{len(wordlist)*len(results)/total_time:.2f} hash/s")
    print(f"   - Time for {len(wordlist)} words: {total_time:.2f}s")
    print(f"   - Success: {cracked}/{len(results)}")
    
    print("\nMD5 (previous attack):")
    print(f"   - Speed: ~500,000+ hash/s")
    print(f"   - Time for same wordlist: <1 second")
    print(f"   - Success: Usually 100%")
    
    print("\nüí° CONCLUSION:")
    print("   bcrypt is ~{:.0f}x SLOWER than MD5".format(500000/(len(wordlist)*len(results)/total_time)))
    print("   This is INTENTIONAL! This slowness protects against brute force.")
    print("\n   On standard hardware:")
    print("   - MD5: All weak passwords cracked in <1 minute")
    print("   - bcrypt: Impractical even with years of computation")

if __name__ == "__main__":
    try:
        brute_force_bcrypt_attack()
    except KeyboardInterrupt:
        print("\n\n  Attack interrupted by user (Ctrl+C)")
        print("This demonstrates that in a real scenario, no one would wait this long!")
    except Exception as e:
        print(f"\n‚ùå Error: {e}")
